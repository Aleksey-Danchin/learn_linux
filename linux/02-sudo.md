# Конспект: Работа с sudo

## Назначение sudo

- **sudo** — утилита для безопасного выполнения команд от имени другого пользователя, обычно root.
- Позволяет выдавать временные привилегии без передачи пароля root.

---

## Основные файлы

- `/etc/sudoers` — основной конфигурационный файл, определяет, кто и что может запускать.
- `/etc/sudoers.d/` — директория для дополнительных конфигураций.

> Редактировать `/etc/sudoers` нужно только через `visudo` — он проверяет синтаксис перед сохранением.

---

## Синтаксис /etc/sudoers

```
user    host = (run_as_user:run_as_group) options command_list
```

- **user** — имя пользователя или `%group` для группы.
- **host** — хост, на котором правило действует (`ALL` для всех).
- **run_as_user** — от имени какого пользователя выполнять.
- **run_as_group** — от имени какой группы выполнять.
- **options** — модификаторы (NOPASSWD и др.).
- **command_list** — список разрешённых команд (или `ALL`).

---

## Примеры записей

1. **root может всё**

```
root ALL=(ALL:ALL) ALL
```

2. **Группа admin может всё**

```
%admin ALL=(ALL) ALL
```

3. **Группа sudo может всё без пароля**

```
%sudo ALL=(ALL:ALL) NOPASSWD: ALL
```

4. **Пользователь alice может перезапускать nginx**

```
alice ALL=(root) /bin/systemctl restart nginx
```

5. **Группа developers может запускать только vim от имени root**

```
%developers ALL=(root) /usr/bin/vim
```

---

## Модификаторы

- **NOPASSWD:** — не требовать пароль при выполнении команд.
- **PASSWD:** — требовать пароль (по умолчанию).
- **NOEXEC:** — запрещает исполнять дочерние программы из команды.
- **SETENV:** — разрешает изменять переменные окружения при sudo.
- **!** — отрицание разрешения.

---

## Алиасы

- **User_Alias** — группа пользователей.
- **Runas_Alias** — группа пользователей, от имени которых можно запускать.
- **Host_Alias** — набор хостов.
- **Cmnd_Alias** — набор команд.

**Пример:**

```
User_Alias ADMINS = alice, bob
Cmnd_Alias RESTART = /bin/systemctl restart nginx, /bin/systemctl restart apache2
ADMINS ALL=(root) NOPASSWD: RESTART
```

---

## Основные команды

- `sudo <команда>` — выполнить команду с привилегиями.
- `sudo -u <user> <команда>` — выполнить от имени указанного пользователя.
- `sudo -g <group> <команда>` — выполнить с указанной группой.
- `sudoedit <файл>` — редактировать файл с правами sudo.
- `visudo` — безопасное редактирование /etc/sudoers.

---

## Сценарии использования

1. **Дать пользователю доступ к админ-командам без пароля:**

```
%devops ALL=(ALL) NOPASSWD: ALL
```

2. **Разрешить только установку пакетов через apt:**

```
alice ALL=(root) /usr/bin/apt install *, /usr/bin/apt remove *
```

3. **Запретить запуск определённых команд:**

```
%devops ALL=(ALL) ALL, !/bin/rm -rf /
```

4. **Разрешить работу от имени конкретного пользователя:**

```
alice ALL=(www-data) ALL
```

---

## Полезные утилиты

- `sudo` — основной инструмент.
- `sudoedit` — безопасное редактирование файлов.
- `visudo` — проверка и редактирование конфигурации sudoers.
- `grep` + `sudo` — для выборки правил.
- `journalctl` — просмотр логов sudo (`journalctl _COMM=sudo`).

---
