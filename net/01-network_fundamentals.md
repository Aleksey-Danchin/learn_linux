# Блок 1 — Сетевой фундамент

## 1. Модель OSI и уровни

Модель OSI (Open Systems Interconnection) — концептуальная модель, описывающая взаимодействие между сетевыми устройствами по уровням.

**Уровень 1 — Физический (Physical)**

- Передача битов по физической среде.
- Определяет электрические, оптические и радиосигналы.
- Примеры: кабели, коннекторы, оптические волокна.

**Уровень 2 — Канальный (Data Link)**

- Работает с кадрами (frames).
- Физическая адресация (MAC-адреса), обнаружение ошибок.
- Примеры: Ethernet, Wi-Fi (канальный уровень).
- Оборудование: коммутаторы.

**Уровень 3 — Сетевой (Network)**

- Работает с пакетами (packets).
- Логическая адресация (IP-адреса) и маршрутизация.
- Протоколы: IPv4, IPv6, ICMP.
- Оборудование: маршрутизаторы.

**Уровень 4 — Транспортный (Transport)**

- Обеспечивает доставку данных от процесса к процессу.
- Управляет сегментацией, контролем потока, проверкой целостности.
- Протоколы: TCP, UDP.

**Уровень 5 — Сеансовый (Session)**

- Управляет установкой, поддержанием и завершением сеансов связи.
- Протоколы: NetBIOS, RPC.

**Уровень 6 — Представления (Presentation)**

- Преобразует данные в формат, пригодный для передачи.
- Кодирование, сжатие, шифрование.
- Примеры: SSL/TLS, JPEG, MP3.

**Уровень 7 — Прикладной (Application)**

- Интерфейс между приложением и сетью.
- Протоколы: HTTP, FTP, DNS, SMTP.

---

## 2. IP-адрес, маска подсети, CIDR

**IP-адрес** — уникальный идентификатор устройства в сети.

**Маска подсети** — определяет, какая часть IP-адреса относится к сети, а какая — к хосту.

**CIDR** — запись адреса и маски в формате `192.168.0.1/24`.

Пример:

- IP: `192.168.1.10`
- Маска: `255.255.255.0` (`/24`)
- Сеть: `192.168.1.0`
- Хосты: `192.168.1.1` – `192.168.1.254`

---

## 3. IPv4 vs IPv6 (базово)

**IPv4:** 32-битный адрес, 4 октета. \~4,3 млрд адресов. **IPv6:** 128-битный адрес, 8 групп по 4 hex-символа. Практически неограниченный пул адресов.

---

## 4. Шлюз по умолчанию

Маршрутизатор, через который отправляется трафик в другие сети.

---

## 5. MAC-адрес

Уникальный физический адрес сетевого интерфейса. Формат: `00:1A:2B:3C:4D:5E`.

---

## 6. Публичные и приватные IP

Приватные IPv4: `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`.

---

## 7. Утилиты: `ping`, `traceroute`, `ipcalc`

```bash
ping 8.8.8.8
traceroute google.com
ipcalc 192.168.1.10/24
```

---

## Практика

1. Определите свой IP, маску, шлюз, MAC.
2. Проверьте доступность `8.8.8.8`.
3. Постройте маршрут до `yandex.ru`.
4. Вычислите сеть для `172.16.5.25/16`.

| Поле / Сокращение            | Полное название                          | Перевод / Смысл                                                            |
| ---------------------------- | ---------------------------------------- | -------------------------------------------------------------------------- |
| **lo**                       | Loopback interface                       | Внутренний интерфейс для связи внутри хоста                                |
| **enpXsY / wlpXsY / enx...** | Ethernet / Wireless LAN Predictable Name | Проводной / Беспроводной интерфейс (с Predictable Network Interface Names) |
| **docker0, br-**\*           | Virtual Bridge Interface                 | Виртуальный сетевой мост (Docker, LXD и др.)                               |
| **<BROADCAST>**              | Broadcast capable                        | Поддерживает широковещательную передачу                                    |
| **<MULTICAST>**              | Multicast capable                        | Поддерживает многоадресную передачу                                        |
| **<UP>**                     | Interface up                             | Интерфейс включен на уровне ОС                                             |
| **\<LOWER_UP>**              | Physical link up                         | Есть физическое соединение (линк)                                          |
| **<NO-CARRIER>**             | No physical carrier                      | Нет линка (кабель не вставлен, Wi-Fi не подключен)                         |
| **mtu**                      | Maximum Transmission Unit                | Максимальный размер передаваемого пакета в байтах                          |
| **qdisc**                    | Queueing Discipline                      | Алгоритм управления очередью пакетов                                       |
| **state**                    | Link state                               | Состояние канала (`UP`, `DOWN`, `UNKNOWN`)                                 |
| **group default**            | Interface group                          | Группа интерфейсов (обычно default)                                        |
| **qlen**                     | Queue length                             | Длина очереди пакетов                                                      |
| **link/ether**               | Ethernet MAC address                     | MAC-адрес сетевого адаптера                                                |
| **brd**                      | Broadcast address                        | Широковещательный адрес                                                    |
| **inet**                     | IPv4 address                             | IP-адрес версии 4                                                          |
| **inet6**                    | IPv6 address                             | IP-адрес версии 6                                                          |
| **scope host**               | Scope: host                              | Область действия: только этот хост                                         |
| **scope link**               | Scope: link                              | Область действия: внутри локальной сети (link-local)                       |
| **scope global**             | Scope: global                            | Глобальная область действия (маршрутизируемый адрес)                       |
| **dynamic**                  | Dynamic address                          | Адрес получен автоматически (DHCP)                                         |
| **noprefixroute**            | No prefix route                          | Без автоматического маршрута по префиксу                                   |
| **valid_lft**                | Valid lifetime                           | Время, в течение которого адрес считается действительным                   |
| **preferred_lft**            | Preferred lifetime                       | Время, в течение которого адрес предпочтителен для использования           |

| Параметр в выводе         | Полное название           | Что делает                          | Управление (команды `ip` и др.)                                           |      |                       |
| ------------------------- | ------------------------- | ----------------------------------- | ------------------------------------------------------------------------- | ---- | --------------------- |
| **UP / DOWN**             | Interface State           | Включает или выключает интерфейс    | `sudo ip link set <iface> up` / `sudo ip link set <iface> down`           |      |                       |
| **LOWER_UP / NO-CARRIER** | Physical link state       | Физический линк есть / отсутствует  | Аппаратно (кабель, Wi-Fi-соединение), либо через `nmcli` / `iw` для Wi-Fi |      |                       |
| **mtu**                   | Maximum Transmission Unit | Максимальный размер пакета          | `sudo ip link set <iface> mtu <размер>`                                   |      |                       |
| **qdisc**                 | Queueing Discipline       | Алгоритм очереди пакетов            | `sudo tc qdisc replace dev <iface> root fq_codel` или `pfifo_fast`        |      |                       |
| **qlen**                  | Queue Length              | Длина очереди пакетов               | `sudo ip link set <iface> txqueuelen <значение>`                          |      |                       |
| **link/ether**            | Ethernet MAC Address      | Физический MAC-адрес адаптера       | `sudo ip link set <iface> address <MAC>` _(iface должен быть DOWN)_       |      |                       |
| **brd**                   | Broadcast Address         | Широковещательный адрес             | `sudo ip addr add <IP>/<mask> brd <broadcast> dev <iface>`                |      |                       |
| **inet**                  | IPv4 Address              | Логический адрес v4                 | `sudo ip addr add <IP>/<mask> dev <iface>` / `sudo ip addr del ...`       |      |                       |
| **inet6**                 | IPv6 Address              | Логический адрес v6                 | `sudo ip addr add <IPv6>/<mask> dev <iface>`                              |      |                       |
| **scope**                 | Address Scope             | Область действия адреса             | \`sudo ip addr add <IP>/<mask> scope {host                                | link | global} dev <iface>\` |
| **dynamic**               | Dynamic Address           | Автоматически назначенный адрес     | Управляется DHCP-клиентом (`dhclient`, `NetworkManager`)                  |      |                       |
| **noprefixroute**         | No Prefix Route           | Не создавать маршрут по префиксу    | `sudo ip addr add <IP>/<mask> noprefixroute dev <iface>`                  |      |                       |
| **valid_lft**             | Valid Lifetime            | Время, когда адрес ещё действителен | `sudo ip addr add <IP>/<mask> valid_lft <сек>`                            |      |                       |
| **preferred_lft**         | Preferred Lifetime        | Время, когда адрес предпочтителен   | `sudo ip addr add <IP>/<mask> preferred_lft <сек>`                        |      |                       |

# Управление интерфейсами в Linux через `ip`

## Что делает `ip link`

Команда `ip link` управляет сетевыми интерфейсами на канальном уровне (L2 в модели OSI). Термин _link_ означает «соединение» или «канал связи». С помощью `ip link` можно:

- включать и выключать интерфейсы (`UP`/`DOWN`)
- изменять MAC-адрес
- настраивать MTU (Maximum Transmission Unit)
- управлять длиной очереди передачи (txqueuelen)

**Примеры:**

```bash
ip link show                          # Показать список интерфейсов
sudo ip link set wlp4s0 down           # Выключить интерфейс
sudo ip link set wlp4s0 mtu 1400       # Изменить MTU
sudo ip link set wlp4s0 address 02:11:22:33:44:55  # Изменить MAC-адрес
sudo ip link set wlp4s0 up             # Включить интерфейс
```

---

## Что такое интерфейс с точки зрения `ip`

С точки зрения утилиты `ip`, **интерфейс** — это любой объект, который может передавать и принимать сетевые пакеты.
Это может быть:

- **Физический** — Ethernet, Wi-Fi-адаптер.
- **Виртуальный** — loopback (`lo`), Docker (`docker0`), VPN (`tun0`), мост (`br0`).
- **Парный адаптер** (`veth`) — для соединения пространств имён (netns).

`ip` может управлять всеми типами интерфейсов одинаково — вне зависимости от того, реальный он или виртуальный.

**Пример создания виртуального интерфейса:**

```bash
ip link add dummy0 type dummy   # Создаём виртуальный интерфейс dummy0
ip addr add 10.10.10.1/24 dev dummy0  # Назначаем ему IPv4-адрес
ip link set dummy0 up                  # Включаем интерфейс
```

### Разбор примера

- **`ip link add dummy0 type dummy`** — создаёт интерфейс с именем `dummy0` типа `dummy`.

  - _Dummy_ — это программный драйвер, который эмулирует сетевую карту. Он не имеет физического соединения, но работает как обычный интерфейс для тестов и отладки.

- **`ip addr add 10.10.10.1/24 dev dummy0`** — назначает IP-адрес интерфейсу.
- **`ip link set dummy0 up`** — включает интерфейс.

### Как дать виртуальному интерфейсу «реальную» аппаратную поддержку

Виртуальный интерфейс сам по себе не подключён к физическому адаптеру. Чтобы он имел доступ в реальную сеть, можно:

1. **Привязать его к мосту (bridge)** вместе с физическим интерфейсом.
2. **Использовать veth-пару** и соединить одну сторону с виртуальной машиной/контейнером, а другую — с физической сетью через мост.
3. **Привязать к tun/tap-устройству** и обрабатывать пакеты в пользовательском пространстве.

Таким образом, dummy — это чисто тестовая «заглушка», а для выхода в реальный мир его нужно связать с физическим интерфейсом через bridge или другой механизм маршрутизации.

# Урок: Управление сетевыми интерфейсами и сетевым стеком в Linux

## 1. Что такое сетевой интерфейс в Linux

Сетевой интерфейс — это **абстракция в ядре**, которая представляет точку входа/выхода сетевых пакетов.

Типы интерфейсов:

- **Физические**: Ethernet (`eth0`), Wi-Fi (`wlp4s0`).
- **Виртуальные**: loopback (`lo`), мосты (`br0`), Docker (`docker0`), VPN (`tun0`).
- **Тестовые**: `dummy`.

Пример создания и настройки dummy-интерфейса:

```bash
sudo ip link add dummy0 type dummy
sudo ip addr add 10.10.10.1/24 dev dummy0
sudo ip link set dummy0 up
```

---

## 2. Команды управления интерфейсами (`ip link` и `ip addr`)

- `ip link` — управление интерфейсами на уровне L2 (вкл/выкл, MAC, MTU, очередь передачи).
- `ip addr` — назначение/удаление IP-адресов, просмотр информации.

Примеры:

```bash
ip link show
sudo ip link set wlp4s0 down
sudo ip link set wlp4s0 mtu 1400
sudo ip addr add 192.168.1.200/24 dev wlp4s0
sudo ip addr del 192.168.1.200/24 dev wlp4s0
```

---

## 3. Понятие очередей RX/TX и qdisc

- **RX** (Receive) — очередь приёма.
- **TX** (Transmit) — очередь передачи.
- **qdisc** (queueing discipline) — алгоритм управления очередью (FIFO, pfifo_fast, fq_codel и др.).

Очереди находятся **в оперативной памяти**, не в файлах.

Просмотр статистики:

```bash
ip -s link
```

---

## 4. Broadcast и Multicast

- **Broadcast** — пакет отправляется всем в локальной сети (адрес IPv4: xxx.xxx.xxx.255).
- **Multicast** — пакет отправляется группе получателей, подписанных на конкретный адрес.

Пример отправки broadcast:

```bash
ping -b 192.168.1.255
```

---

## 5. Scope IP-адресов

`scope` определяет область видимости IP:

- `host` — адрес доступен только локально.
- `link` — доступен в пределах одного канала связи.
- `global` — доступен глобально.

Пример:

```bash
sudo ip addr add 10.10.10.1/32 dev wlp4s0 scope host
```

> Даже с `scope host` пакет может выйти наружу, если маршрут это допускает. Scope — это подсказка для маршрутизации, а не фильтр на отправку.

---

## 6. valid_lft / preferred_lft

- `valid_lft` — срок действия адреса (после истечения адрес удаляется).
- `preferred_lft` — время, когда адрес является предпочтительным для исходящих соединений.

Пример:

```bash
sudo ip addr add 2001:db8::1/64 dev eth0 valid_lft 600 preferred_lft 300
```

---

## 7. Удаление и восстановление интерфейсов

- Виртуальные интерфейсы можно удалять:

```bash
sudo ip link del dummy0
```

- Физические интерфейсы при удалении можно вернуть загрузкой модуля драйвера:

```bash
sudo modprobe <driver_name>
```

---

## 8. Работа с несколькими IP на одном интерфейсе

Можно назначить несколько IP на один интерфейс:

```bash
sudo ip addr add 192.168.1.210/24 dev wlp4s0
sudo ip addr add 192.168.1.220/24 dev wlp4s0
```

RX очередь у интерфейса будет **общая** для всех IP, но фильтрация по IP идёт на более поздних этапах.

---

## 9. Отладка с tcpdump

Просмотр ICMP-трафика:

```bash
sudo tcpdump -ni wlp4s0 icmp
```

---

## 10. Рекомендуемые книги

- _Understanding Linux Network Internals_ — глубоко про сетевой стек Linux.
- _Linux Kernel Networking_ — архитектура сетевой подсистемы.
- _TCP/IP Illustrated_ (Vol. 1 и 2) — подробности протоколов и реализации.
- _The Linux Programming Interface_ — системное программирование в Linux.

# Урок: Путешествие одного пакета в Linux

## 1. Приложение (user space)

```bash
ping 8.8.8.8
```

- `ping` создаёт сокет (`SOCK_RAW` для ICMP).
- Формирует ICMP Echo Request.

---

## 2. Переход в ядро (syscall → net stack)

- Через `sendto()` пакет попадает в сетевой стек ядра.
- Ядро смотрит таблицу маршрутов (`ip route show`) и выбирает интерфейс.
- На этом этапе учитываются:

  - `scope` (host/link/global)
  - policy routing
  - правила firewall (OUTPUT chain).

---

## 3. Кладём в TX очередь интерфейса

- Пакет передаётся в TX очередь `wlp4s0`.
- Перед этим проходит через **qdisc** (FIFO, fq_codel, и др.).
- Qdisc может влиять на порядок и скорость отправки.

---

## 4. Драйвер и аппаратная очередь

- Драйвер получает пакет, преобразует в формат для Wi-Fi.
- Кладёт в аппаратный ring buffer карты.
- Карта отправляет кадр по радио.

---

## 5. Дальнейший путь в сети

- Роутер принимает кадр, снимает MAC-заголовок.
- Пересылает пакет дальше к провайдеру.
- Провайдер → магистраль → датацентр Google.

---

## 6. Ответный пакет (Echo Reply)

- 8.8.8.8 отправляет ICMP Echo Reply.
- Пакет приходит обратно через роутер по Wi-Fi.
- Попадает в RX очередь интерфейса → драйвер → ядро → сокет `ping`.

---

## 7. Отображение результата

- `ping` выводит: `64 bytes from 8.8.8.8: icmp_seq=1 ttl=118 time=17.2 ms`.

---

## Подсказки для наблюдения за пакетами

- На этапе 2–3: `ip route`, `tc qdisc show`.
- На этапе 4: `ethtool -S wlp4s0`.
- На любом этапе: `tcpdump -ni wlp4s0`.

---

## 11. Путешествие одного пакета (на примере `ping 8.8.8.8`)

### 11.1. Приложение (user space)

```bash
ping 8.8.8.8
```

- `ping` создаёт ICMP Echo Request (использует `RAW`-сокет) и вызывает `sendto()`.

### 11.2. Переход в ядро (сетевой стек)

- Пакет попадает в стек `IP → (возможен firewall OUTPUT) → маршрутизация`.
- Ядро выбирает маршрут: `default via <шлюз> dev wlp4s0`.
- Здесь учитываются `scope`, policy routing (`ip rule`), таблицы маршрутов (`ip route`), правила firewall.

**Полезные команды:**

```bash
ip route show\ nip rule show
sudo iptables -S OUTPUT     # или nft list ruleset
```

### 11.3. Очередь передачи и qdisc

- Пакет помещается в **TX queue** интерфейса `wlp4s0`.
- **qdisc** (напр. `fq_codel`) определяет порядок/скорость/дропы.

**Посмотреть qdisc:**

```bash
tc qdisc show dev wlp4s0
```

### 11.4. Драйвер и железо

- Драйвер формирует кадр для устройства (Ethernet/Wi‑Fi), кладёт в аппаратный ring buffer.
- Устройство передаёт кадр в среду (эфир/кабель).

**Статистика драйвера/буферов:**

```bash
ethtool -S wlp4s0
ethtool -g wlp4s0
```

### 11.5. В сети

- Роутер снимает L2-заголовок, маршрутизирует IP‑пакет дальше (NAT/маскарадинг — по настройкам).
- Пакет уходит к провайдеру → магистраль → узел назначения.

### 11.6. Обратный путь (Echo Reply)

- Ответ приходит на роутер → по Wi‑Fi на `wlp4s0` → **RX queue** → сетевой стек ядра → сокет `ping`.
- `ping` печатает строку `64 bytes from ... time=...`.

**Наблюдение трафика:**

```bash
sudo tcpdump -ni wlp4s0 icmp
```

### 11.7. Где смотреть/чинить по шагам

- **Маршруты/правила:** `ip route`, `ip rule`.
- **qdisc/очереди:** `tc -s qdisc show dev wlp4s0`.
- **RX/TX счётчики:** `ip -s link show wlp4s0`, `ethtool -S wlp4s0`.
- **Firewall:** `iptables -nvL` или `nft list ruleset`.
- **Сниффер:** `tcpdump -ni wlp4s0 icmp`.

> Примечание: если задаёшь «нестандартный» исходник (например, `-I 10.10.10.1` вне подсети LAN), запросы могут уйти, но ответы потеряются без маршрута/маскарадинга. Решения: статический маршрут на роутере, SNAT на хосте, либо использовать адрес из своей подсети.
